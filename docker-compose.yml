name: codex-coordinator

services:
  api:
    build: .
    depends_on:
      - mysql
    ports:
      - "127.0.0.1:8488:80"
    healthcheck:
      test: ["CMD-SHELL", "php -r 'exit(@file_get_contents(\"http://127.0.0.1/versions\")===false);'"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    environment:
      DB_DRIVER: mysql
      DB_HOST: ${DB_HOST:-mysql}
      DB_PORT: ${DB_PORT:-3306}
      DB_DATABASE: ${DB_DATABASE:-codex_auth}
      DB_USERNAME: ${DB_USERNAME:-codex}
      DB_PASSWORD: ${DB_PASSWORD:-codex-pass}
      AUTH_RUNNER_URL: ${AUTH_RUNNER_URL:-http://auth-runner:8080/verify}
      AUTH_RUNNER_CODEX_BASE_URL: ${AUTH_RUNNER_CODEX_BASE_URL:-https://codex-auth.example.com}
      AUTH_RUNNER_TIMEOUT: ${AUTH_RUNNER_TIMEOUT:-8}
      AUTH_RUNNER_IP_BYPASS: ${AUTH_RUNNER_IP_BYPASS:-1}
      AUTH_RUNNER_BYPASS_SUBNETS: ${AUTH_RUNNER_BYPASS_SUBNETS:-172.28.0.0/16,172.30.0.0/16}
      ADMIN_ACCESS_MODE: ${ADMIN_ACCESS_MODE:-mtls}
    volumes:
      - ${ENV_FILE:-./.env}:/var/www/html/.env
      - ${DATA_ROOT:-/var/docker_data/codex-auth.example.com}/store:/var/www/html/storage
    networks:
      - codex_auth
    restart: unless-stopped

  quota-cron:
    build: .
    depends_on:
      - mysql
    environment:
      DB_DRIVER: mysql
      DB_HOST: ${DB_HOST:-mysql}
      DB_PORT: ${DB_PORT:-3306}
      DB_DATABASE: ${DB_DATABASE:-codex_auth}
      DB_USERNAME: ${DB_USERNAME:-codex}
      DB_PASSWORD: ${DB_PASSWORD:-codex-pass}
      CHATGPT_USAGE_CRON_INTERVAL: ${CHATGPT_USAGE_CRON_INTERVAL:-3600}
    volumes:
      - ${ENV_FILE:-./.env}:/var/www/html/.env
      - ${DATA_ROOT:-/var/docker_data/codex-auth.example.com}/store:/var/www/html/storage
    networks:
      - codex_auth
    command: >
      bash -c "interval=${CHATGPT_USAGE_CRON_INTERVAL:-3600};
        if [[ -z \"$$interval\" || ! \"$$interval\" =~ ^[0-9]+$ ]]; then interval=3600; fi;
        while true; do
          if php /var/www/html/scripts/refresh-chatgpt-usage.php; then
            sleep \"$$interval\";
          else
            echo '[quota-cron] refresh failed; retrying in 60s' >&2;
            sleep 60;
          fi
        done"
    healthcheck:
      test: ["CMD-SHELL", "MYSQL_PWD=\"$$DB_PASSWORD\" mysqladmin --skip-ssl --protocol=tcp ping -h \"$$DB_HOST\" -u\"$$DB_USERNAME\" --silent"]
      interval: 60s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  auth-runner:
    build:
      context: .
      dockerfile: runner/Dockerfile
    depends_on:
      - api
    environment:
      CODEX_SYNC_BASE_URL: ${CODEX_SYNC_BASE_URL:-https://codex-auth.example.com}
      CODEX_DEBUG: ${CODEX_DEBUG:-0}
    expose:
      - "8080"
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request,sys; sys.exit(0 if urllib.request.urlopen('http://127.0.0.1:8080/health').status==200 else 1)\""]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - codex_auth
    restart: unless-stopped

  caddy:
    image: caddy:2.8
    profiles:
      - caddy
    depends_on:
      - api
    ports:
      - "80:80"
      - "443:443"
    environment:
      CADDY_DOMAIN: ${CADDY_DOMAIN:-codex-auth.example.com}
      CADDY_ACME_EMAIL: ${CADDY_ACME_EMAIL:-ops@example.com}
      CADDY_TLS_FRAGMENT: ${CADDY_TLS_FRAGMENT:-/etc/caddy/tls-acme.caddy}
      CADDY_TLS_CERT_FILE: ${CADDY_TLS_CERT_FILE:-/etc/caddy/tls/tls.crt}
      CADDY_TLS_KEY_FILE: ${CADDY_TLS_KEY_FILE:-/etc/caddy/tls/tls.key}
      CADDY_MTLS_CA_FILE: ${CADDY_MTLS_CA_FILE:-/etc/caddy/mtls/ca.crt}
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./caddy/tls-acme.caddy:/etc/caddy/tls-acme.caddy:ro
      - ./caddy/tls-custom.caddy:/etc/caddy/tls-custom.caddy:ro
      - ${CADDY_TLS_DIR:-/var/docker_data/codex-auth.example.com/caddy/tls}:/etc/caddy/tls:ro
      - ${CADDY_MTLS_DIR:-/var/docker_data/codex-auth.example.com/caddy/mtls}:/etc/caddy/mtls:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - codex_auth
    healthcheck:
      test: ["CMD", "caddy", "version"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  mysql:
    image: mysql:8.0
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_DATABASE: ${DB_DATABASE:-codex_auth}
      MYSQL_USER: ${DB_USERNAME:-codex}
      MYSQL_PASSWORD: ${DB_PASSWORD:-codex-pass}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-root-pass}
    volumes:
      - ${DATA_ROOT:-/var/docker_data/codex-auth.example.com}/mysql_data:/var/lib/mysql
      - ${DATA_ROOT:-/var/docker_data/codex-auth.example.com}/store/sql:/docker-entrypoint-initdb.d:ro
    networks:
      - codex_auth
    healthcheck:
      test: ["CMD-SHELL", "MYSQL_PWD=\"$$MYSQL_PASSWORD\" mysqladmin ping -h 127.0.0.1 -u\"$$MYSQL_USER\" --silent"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  mysql-backup:
    image: databack/mysql-backup
    profiles:
      - backup
    environment:
      DB_SERVER: mysql
      DB_PORT: 3306
      DB_USER: ${DB_USERNAME:-codex}
      DB_PASSWORD: ${DB_PASSWORD:-codex-pass}
      DB_NAMES: ${DB_DATABASE:-codex_auth}
      CRON_TIME: ${DB_BACKUP_CRON:-0 2 * * *}
      MAX_BACKUPS: ${DB_BACKUP_MAX:-30}
      TZ: ${TZ:-UTC}
    command:
      - dump
      - --server
      - ${DB_HOST:-mysql}
      - --port
      - "${DB_PORT:-3306}"
      - --user
      - ${DB_USERNAME:-codex}
      - --pass
      - ${DB_PASSWORD:-codex-pass}
      - --include
      - ${DB_NAMES:-codex_auth}
      - --target
      - file:///backup
      - --begin
      - "${DB_BACKUP_BEGIN:-0200}"
      - --frequency
      - "${DB_BACKUP_FREQUENCY:-1440}"
      - --retention
      - "${DB_BACKUP_MAX:-30}c"
    volumes:
      - ${DATA_ROOT:-/var/docker_data/codex-auth.example.com}/store/sql:/backup
    depends_on:
      - mysql
    networks:
      - codex_auth
    healthcheck:
      test: ["CMD-SHELL", "kill -0 1"]
      interval: 60s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

networks:
  codex_auth:

volumes:
  caddy_data:
  caddy_config:

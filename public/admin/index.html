<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Codex-Auth</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dashboard.css">
  <link rel="stylesheet" href="dashboard-mobile.css">
</head>
<body data-view="desktop">
  <div class="glow glow-a"></div>
  <div class="glow glow-b"></div>
  <div class="app">
    <div class="content">
      <header class="topbar">
        <div class="title-line">
          <div class="brand-mark" aria-hidden="true"></div>
          <h2>Codex-Auth</h2>
          <div id="mtls" class="pill" style="display:none;">mTLS Status</div>
        </div>
        <div class="action-line">
          <button class="ghost" id="api-toggle-btn" title="Emergency stop for Codex agents">API</button>
          <button class="ghost runner-ghost" id="uploadAuthBtn">Seed</button>
          <button class="ghost runner-ghost" id="newHostBtn">+ New Host</button>
          <button class="ghost tiny-btn runner-ghost" id="runner-runner" title="Run auth-runner now">↻ Runner</button>
          <button class="ghost runner-ghost" id="version-check">Check versions</button>
        </div>
      </header>
    <main class="main">
        <div class="modal-backdrop" id="seedModal">
          <div class="modal seed-modal">
            <h3>Initial seeding required</h3>
            <p class="muted" id="seedModalCopy">This installation has no hosts or canonical auth.json yet. Seed auth.json before issuing installers.</p>
            <div class="seed-status">
              <div class="seed-chip warn" id="seedHostsStatus"><span class="dot"></span>No hosts registered</div>
              <div class="seed-chip warn" id="seedAuthStatus"><span class="dot"></span>Canonical auth.json missing</div>
            </div>
            <div class="actions">
              <button class="ghost" id="seedDismissBtn">Close</button>
              <button id="seedUploadBtn">Seed auth.json</button>
            </div>
          </div>
        </div>
        <div class="modal-backdrop" id="newHostModal">
          <div class="modal">
            <h3>New Host</h3>
            <p>Issue a one-time installer link for this FQDN. The API key is baked in and bound to this host on first contact.</p>
            <div class="field">
              <label for="new-host-name" style="font-weight:600;">Host FQDN</label>
              <input id="new-host-name" type="text" placeholder="e.g. node-01.example.com">
            </div>
            <div class="field">
              <label class="toggle" for="secureHostToggle">
                <input type="checkbox" id="secureHostToggle" checked>
                <span class="track"><span class="thumb"></span></span>
                <span class="toggle-text">Secure host (keep auth.json after runs)</span>
              </label>
              <p class="muted" style="margin:6px 0 0;">Off = treat as insecure; cdx removes auth.json after each run.</p>
            </div>
            <div class="field">
              <label class="toggle" for="insecureToggle">
                <input type="checkbox" id="insecureToggle">
                <span class="track"><span class="thumb"></span></span>
                <span class="toggle-text">Allow insecure curl (-k)</span>
              </label>
            </div>
            <div class="field" id="commandField" style="display:none;">
              <label style="font-weight:600;">Run on the target host</label>
              <div class="command-box">
                <span class="cmd-text" id="bootstrapCmd"></span>
                <button class="copy-btn" id="copyCmd">Copy</button>
              </div>
              <p class="muted" id="installerMeta" style="margin-top:8px; display:none;"></p>
              <p class="muted" style="margin-top:8px;">Single command downloads the baked installer and configures the host.</p>
              </div>
            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:6px;">
              <button class="ghost" id="cancelNewHost">Cancel</button>
              <button id="createHost">Generate</button>
            </div>
          </div>
        </div>

        <div class="modal-backdrop" id="promptModal">
          <div class="modal">
            <h3>Edit Slash Command</h3>
            <div class="field">
              <label style="font-weight:600;">Filename</label>
              <input id="promptFilename" type="text" readonly>
            </div>
            <div class="field">
              <label style="font-weight:600;">Description</label>
              <input id="promptDescription" type="text" placeholder="Short description">
            </div>
            <div class="field">
              <label style="font-weight:600;">Argument hint</label>
              <input id="promptArgument" type="text" placeholder='e.g. [MESSAGE="<commit message>"]'>
            </div>
            <div class="field">
              <label style="font-weight:600;">Prompt</label>
              <textarea id="promptBody" rows="12" placeholder="Full prompt content"></textarea>
            </div>
            <div id="promptStatus" class="muted" style="min-height:18px; font-size:13px;"></div>
            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:6px;">
              <button class="ghost" id="promptCancel">Cancel</button>
              <button id="promptSave">Save</button>
            </div>
          </div>
        </div>
        <div class="modal-backdrop" id="uploadModal">
          <div class="modal">
            <h3>Seed auth.json</h3>
            <p>Paste or choose an auth.json; it will be validated via the runner and stored as canonical.</p>
            <div class="field">
              <label for="uploadHostSelect" style="font-weight:600;">Store scope</label>
              <select id="uploadHostSelect"></select>
            </div>
            <div class="field">
              <label for="uploadAuthText" style="font-weight:600;">auth.json</label>
              <textarea id="uploadAuthText" rows="8" placeholder='{"last_refresh":"...","auths":{...}}'></textarea>
            </div>
            <div class="field">
              <label style="font-weight:600;">or choose file</label>
              <input type="file" id="uploadAuthFile" accept=".json,application/json">
            </div>
            <div id="uploadStatus" class="muted" style="min-height:18px; font-size:13px;"></div>
            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:6px;">
              <button class="ghost" id="uploadAuthCancel">Cancel</button>
              <button id="uploadAuthSubmit">Upload</button>
            </div>
          </div>
        </div>
        <div class="modal-backdrop" id="deleteHostModal">
          <div class="modal">
            <h3>Remove host</h3>
            <p id="delete-host-text" class="muted"></p>
            <div class="actions">
              <button class="ghost" id="cancelDeleteHost">Cancel</button>
              <button class="danger" id="confirmDeleteHost">Remove</button>
            </div>
          </div>
        </div>
        <div class="modal-backdrop" id="hostDetailModal">
          <div class="modal host-detail-modal">
            <div class="host-detail-head">
              <div>
                <p class="muted overline">Authorized Host</p>
                <h3 id="hostDetailTitle">Loading…</h3>
                <div class="chip-row" id="hostDetailPills"></div>
              </div>
              <div class="host-detail-head-actions">
                <button class="ghost tiny-btn" id="closeHostDetail">Close</button>
              </div>
            </div>
            <div class="host-detail-summary" id="hostDetailSummary"></div>
            <div class="kv-grid" id="hostDetailGrid"></div>
            <div class="host-detail-actions" id="hostDetailActions"></div>
          </div>
        </div>
        <div class="modal-backdrop" id="runnerModal">
          <div class="modal">
            <h3>Auth runner</h3>
            <p class="muted">Manual runner invocation with live output and the final decision.</p>
            <div class="runner-meta" id="runnerMeta"></div>
            <div class="runner-log" id="runnerLog" aria-live="polite"></div>
            <div class="actions">
              <button class="ghost" id="runnerClose">Close</button>
            </div>
          </div>
        </div>
        <div class="modal-backdrop" id="upgradeModal">
          <div class="modal">
            <h3>Codex Upgrade Notes</h3>
            <p class="muted" id="upgradeVersionLabel"></p>
            <div class="upgrade-notes" id="upgradeNotes">Loading…</div>
            <div class="actions">
              <button class="ghost" id="upgradeGithubLink" type="button">Open on GitHub</button>
              <button class="ghost" id="upgradeClose">Close</button>
            </div>
          </div>
        </div>

        <div class="modal-backdrop" id="usageHistoryModal">
          <div class="modal usage-history-modal">
            <div class="modal-head">
              <div>
                <h3>ChatGPT Quota Trend</h3>
                <p class="muted" id="usageHistorySubtitle">Loading…</p>
              </div>
              <button class="ghost tiny-btn" id="usageHistoryClose">Close</button>
            </div>
            <div class="usage-history-chart" id="usageHistoryChart">Loading…</div>
            <div class="muted" id="usageHistoryMeta" style="margin-top:8px;"></div>
          </div>
        </div>

        <section class="grid metrics" id="stats"></section>

        <section class="card usage-card" id="chatgpt-usage-card">
          <div class="muted">Loading ChatGPT usage…</div>
        </section>

        <section class="card panel" id="hosts-panel">
          <div class="panel-head">
            <div>
              <h2>Authorized Hosts</h2>
            </div>
            <div class="panel-actions">
              <input type="search" id="host-filter" placeholder="Search host, IP, or version">
            </div>
          </div>
          <div class="table-wrap">
            <table id="hosts">
              <thead>
                <tr>
                  <th>Host</th>
                  <th>Last Seen</th>
                  <th>Client</th>
                  <th>Wrapper</th>
                  <th>IP / Mode</th>
                  <th>Insecure API</th>
                </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
        </section>

        <section class="card panel" id="prompts-panel">
          <div class="panel-head">
            <div>
              <h2>Slash Commands</h2>
              <p class="muted" style="margin:4px 0 0;">Server-stored prompts baked into hosts (synced by cdx)</p>
            </div>
          </div>
          <div class="table-wrap">
            <table id="prompts">
              <thead>
                <tr>
                  <th>Filename</th>
                  <th>Description</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <section class="card panel" id="quota-panel">
          <div class="panel-head" style="align-items:center; gap:12px;">
            <div>
              <h2>Quota Policy</h2>
              <p class="muted quota-desc" style="margin:4px 0 0;">ChatGPT quota hit: deny Codex launch.</p>
            </div>
            <label class="toggle" for="quotaHardFailToggle" style="margin-left:auto;">
              <input type="checkbox" id="quotaHardFailToggle">
              <span class="track"><span class="thumb"></span></span>
              <span class="toggle-text" id="quotaModeLabel">Deny launches</span>
            </label>
          </div>
        </section>

      </main>
    </div>
  </div>

  <script src="dashboard.js"></script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MCP Access Logs</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dashboard.css?v=2025-12-08-30">
  <link rel="stylesheet" href="dashboard-mobile.css?v=2025-12-08-02">
</head>
<body data-view="desktop">
  <header class="main-nav">
    <div class="nav-brand">
      <img class="brand-logo" src="openai-logo.svg" alt="OpenAI logo">
      <div>
        <div class="brand-title">Codex Coordinator</div>
      </div>
    </div>
    <nav class="nav-groups">
      <a class="nav-item" href="/admin/?view=dashboard" data-nav="dashboard">Dashboard</a>
      <a class="nav-item" href="/admin/hosts.html" data-nav="hosts">Hosts</a>
      <a class="nav-item" href="/admin/logs.html" data-nav="logs">Logs</a>
      <a class="nav-item" href="/admin/settings.html" data-nav="settings">Settings</a>
    </nav>
    <div class="nav-actions">
      <button class="nav-btn primary" onclick="window.location.href='/admin/?newHost=1#hosts-panel'">New host</button>
    </div>
  </header>

  <div class="app">
    <div class="content">
      <section class="page-hero">
        <div>
          <p class="eyebrow">Logs</p>
          <h1>MCP Access</h1>
          <p class="muted">Latest MCP requests from hosts. Click a row for details.</p>
        </div>
      </section>
      <div class="log-tabs" role="tablist" aria-label="Log type tabs">
        <a class="log-tab" data-log-tab="client" href="/admin/logs.html">Client logs</a>
        <a class="log-tab active" data-log-tab="mcp" href="/admin/mcp-logs.html">MCP access</a>
      </div>

      <section class="card panel log-panel">
        <div class="panel-head">
          <div>
            <h2>Client Reports</h2>
            <p class="muted" style="margin:4px 0 0;">Newest first · search by host or IP · click headers to sort.</p>
          </div>
          <div class="panel-actions log-actions">
            <input type="search" id="mcp-search" placeholder="Search host or IP">
            <select id="mcp-page-size" title="Rows per page">
              <option value="25">25 / page</option>
              <option value="50" selected>50 / page</option>
              <option value="100">100 / page</option>
            </select>
            <button id="mcp-refresh" class="ghost tiny-btn" type="button">↻ Refresh</button>
          </div>
        </div>
        <div class="table-wrap log-table-wrap">
          <table id="logTable">
            <thead>
              <tr>
                <th class="sortable" data-sort="created_at">Time (UTC)</th>
                <th class="sortable" data-sort="host">Host</th>
                <th class="sortable" data-sort="method">Method</th>
                <th class="sortable" data-sort="name">Name</th>
                <th class="sortable" data-sort="client_ip">IP</th>
                <th class="sortable" data-sort="success">Status</th>
                <th class="sortable" data-sort="error_code">Error</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="log-footer">
          <div id="mcp-footer-status" class="muted">Loading…</div>
          <div class="log-pagination">
            <button id="mcp-page-prev" class="ghost tiny-btn">← Prev</button>
            <div class="page-indicator" id="mcp-page-indicator">Page 1 / 1</div>
            <button id="mcp-page-next" class="ghost tiny-btn">Next →</button>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div class="modal-backdrop" id="detailModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div>
          <h3 id="modalTitle">MCP Request</h3>
          <div class="muted" id="modalSubtitle"></div>
        </div>
        <button id="modalClose" class="close-btn ghost tiny-btn" aria-label="Close">×</button>
      </div>
      <div id="modalBody" class="detail-grid"></div>
    </div>
  </div>

  <script src="nav.js?v=2025-12-08-06"></script>
  <script>
    (function () {
      const tbody = document.querySelector('#logTable tbody');
      const statusEl = document.getElementById('mcp-status') || document.getElementById('mcp-footer-status');
      const footerStatusEl = document.getElementById('mcp-footer-status');
      const searchInput = document.getElementById('mcp-search');
      const pageSizeSelect = document.getElementById('mcp-page-size');
      const refreshBtn = document.getElementById('mcp-refresh');
      const pagePrevBtn = document.getElementById('mcp-page-prev');
      const pageNextBtn = document.getElementById('mcp-page-next');
      const pageIndicator = document.getElementById('mcp-page-indicator');
      let rowsCache = [];
      let filteredRows = [];
      let currentPage = 1;
      let pageSize = 50;
      let sortKey = 'created_at';
      let sortDir = 'desc';
      const modal = document.getElementById('detailModal');
      const modalBody = document.getElementById('modalBody');
      const modalTitle = document.getElementById('modalTitle');
      const modalSubtitle = document.getElementById('modalSubtitle');

      function renderPage() {
        const start = (currentPage - 1) * pageSize;
        const pageRows = filteredRows.slice(start, start + pageSize);
        render(pageRows);
        const totalPages = Math.max(1, Math.ceil(filteredRows.length / pageSize));
        pageIndicator.textContent = `Page ${Math.min(currentPage, totalPages)} / ${totalPages}`;
        pagePrevBtn.disabled = currentPage <= 1;
        pageNextBtn.disabled = currentPage >= totalPages;
        if (footerStatusEl) {
          footerStatusEl.textContent = filteredRows.length
            ? `Showing ${pageRows.length} of ${filteredRows.length}`
            : 'No entries yet.';
        }
      }

      function applyFilters() {
        const q = (searchInput?.value || '').trim().toLowerCase();
        filteredRows = rowsCache.filter((row) => {
          if (!q) return true;
          const haystack = [row.host_fqdn, row.fqdn, row.host, row.host_id, row.client_ip]
            .map(v => (v || '').toString().toLowerCase());
          return haystack.some(v => v.includes(q));
        });
        sortRows();
        currentPage = 1;
        renderPage();
      }

      function sortRows() {
        const dir = sortDir === 'asc' ? 1 : -1;
        filteredRows.sort((a, b) => {
          const av = a[sortKey];
          const bv = b[sortKey];
          if (av === bv) return 0;
          if (av === undefined || av === null) return 1;
          if (bv === undefined || bv === null) return -1;
          return av > bv ? dir : -dir;
        });
      }

      async function loadLogs() {
        const limit = 500; // fetch plenty; we page client-side
        if (statusEl) statusEl.textContent = 'Loading…';
        try {
          const res = await fetch(`/admin/mcp/logs?limit=${limit}`, { credentials: 'include' });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          rowsCache = data?.data?.logs || [];
          if (statusEl) statusEl.textContent = `${rowsCache.length} loaded`;
          applyFilters();
        } catch (err) {
          if (statusEl) statusEl.textContent = `Error: ${err.message}`;
          footerStatusEl.textContent = 'Error loading logs';
        }
      }

      function render(rows) {
        tbody.innerHTML = '';
        if (!rows.length) {
          tbody.innerHTML = '<tr><td class="muted" colspan="7">No entries yet.</td></tr>';
          return;
        }

        rows.forEach((row) => {
          const tr = document.createElement('tr');
          const created = formatUtc(row.created_at);
          const host = formatHost(row);
          const ok = normalizeSuccess(row.success);
          const errorText = formatError(row);

          tr.innerHTML = `
            <td><span class="mono">${escapeHtml(created)}</span></td>
            <td>${escapeHtml(host)}</td>
            <td><code>${escapeHtml(row.method || '')}</code></td>
            <td>${escapeHtml(row.name || '')}</td>
            <td><span class="mono">${escapeHtml(row.client_ip || '')}</span></td>
            <td>${successPill(ok)}</td>
            <td>${escapeHtml(errorText)}</td>
          `;

          tr.addEventListener('click', () => openModal(row, { created, host, ok, errorText }));
          tbody.appendChild(tr);
        });
      }

      function formatHost(row) {
        const host = row.host_fqdn ?? row.fqdn ?? row.host ?? row.host_id ?? '';
        return host ? String(host) : '—';
      }

      function normalizeSuccess(value) {
        if (typeof value === 'boolean') return value;
        if (typeof value === 'string') {
          const lower = value.trim().toLowerCase();
          if (lower === 'false') return false;
          if (lower === 'true') return true;
        }
        const num = Number(value);
        if (Number.isFinite(num)) return num > 0;
        return Boolean(value);
      }

      function successPill(ok) {
        return ok ? '<span class="pill ok">ok</span>' : '<span class="pill err">fail</span>';
      }

      function formatError(row) {
        if (row.error_code === null || row.error_code === undefined || row.error_code === '') return '';
        const msg = row.error_message ? ` ${row.error_message}` : '';
        return `${row.error_code}${msg}`;
      }

      function parseTimestamp(value) {
        if (!value) return null;
        const normalized = String(value).replace(/\.(\d{3})\d*(Z?)/, '.$1$2');
        const date = new Date(normalized);
        return Number.isNaN(date.getTime()) ? null : date;
      }

      function formatUtc(value) {
        const date = parseTimestamp(value);
        if (!date) return value || '—';
        const dd = String(date.getUTCDate()).padStart(2, '0');
        const mm = String(date.getUTCMonth() + 1).padStart(2, '0');
        const yyyy = date.getUTCFullYear();
        const hh = String(date.getUTCHours()).padStart(2, '0');
        const min = String(date.getUTCMinutes()).padStart(2, '0');
        const ss = String(date.getUTCSeconds()).padStart(2, '0');
        return `${dd}.${mm}.${yyyy}, ${hh}:${min}:${ss}`;
      }

      function escapeHtml(str) {
        return String(str ?? '').replace(/[&<>"']/g, (c) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
      }

      function detailRow(label, value, mono = false, allowHtml = false) {
        const classes = `detail-value${mono ? ' mono' : ''}`;
        const display = value === null || value === undefined || value === '' ? '—' : value;
        const content = allowHtml ? display : escapeHtml(display);
        return `<div class="detail-label">${escapeHtml(label)}</div><div class="${classes}">${content}</div>`;
      }

      function openModal(row, derived = {}) {
        const created = derived.created ?? formatUtc(row.created_at);
        const host = derived.host ?? formatHost(row);
        const ok = typeof derived.ok === 'boolean' ? derived.ok : normalizeSuccess(row.success);
        const errorText = derived.errorText ?? formatError(row);

        modalTitle.textContent = row.method ? `MCP ${row.method}` : 'MCP Request';
        modalSubtitle.textContent = created && created !== '—' ? `${created} UTC` : '';
        modalBody.innerHTML = [
          detailRow('Time (UTC)', created, true),
          detailRow('Host', host),
          detailRow('Client IP', row.client_ip || '—', true),
          detailRow('Method', row.method || '—', true),
          detailRow('Name', row.name || '—'),
          detailRow('Status', successPill(ok), false, true),
          detailRow('Error Code', row.error_code ?? '—', true),
          detailRow('Error Message', row.error_message || '—'),
          detailRow('Log ID', row.id ?? '—', true),
        ].join('');

        modal.classList.add('show');
        modal.setAttribute('aria-hidden', 'false');
      }

      function closeModal() {
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden', 'true');
      }

      refreshBtn.addEventListener('click', loadLogs);
      if (searchInput) {
        searchInput.addEventListener('input', () => applyFilters());
      }
      if (pageSizeSelect) {
        pageSizeSelect.addEventListener('change', () => {
          const val = parseInt(pageSizeSelect.value || '50', 10);
          if (Number.isFinite(val) && val > 0) {
            pageSize = val;
            currentPage = 1;
            renderPage();
          }
        });
      }
      pagePrevBtn.addEventListener('click', (event) => {
        event.preventDefault();
        if (currentPage > 1) {
          currentPage -= 1;
          renderPage();
        }
      });
      pageNextBtn.addEventListener('click', (event) => {
        event.preventDefault();
        const totalPages = Math.max(1, Math.ceil(filteredRows.length / pageSize));
        if (currentPage < totalPages) {
          currentPage += 1;
          renderPage();
        }
      });
      document.getElementById('modalClose').addEventListener('click', closeModal);
      modal.addEventListener('click', (event) => {
        if (event.target === modal) closeModal();
      });
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && modal.classList.contains('show')) {
          closeModal();
        }
      });

      const sortableHeaders = document.querySelectorAll('th.sortable');
      sortableHeaders.forEach((th) => {
        th.addEventListener('click', () => {
          const key = th.getAttribute('data-sort') || 'created_at';
          if (sortKey === key) {
            sortDir = sortDir === 'asc' ? 'desc' : 'asc';
          } else {
            sortKey = key;
            sortDir = key === 'created_at' ? 'desc' : 'asc';
          }
          sortRows();
          renderPage();
        });
      });

      loadLogs();
    })();
  </script>
</body>
</html>

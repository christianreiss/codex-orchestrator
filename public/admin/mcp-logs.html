<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MCP Access Logs</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dashboard.css?v=2025-12-08-09">
  <link rel="stylesheet" href="dashboard-mobile.css?v=2025-12-08-02">
</head>
<body data-view="desktop">
  <header class="main-nav">
    <div class="nav-brand">
      <img class="brand-logo" src="openai-logo.svg" alt="OpenAI logo">
      <div>
        <div class="brand-title">Codex Coordinator</div>
      </div>
    </div>
    <nav class="nav-groups">
      <a class="nav-item" href="/admin/?view=dashboard" data-nav="dashboard">Dashboard</a>
      <div class="nav-item has-children" data-nav="hosts">
        <button type="button" class="nav-trigger" aria-expanded="false"><span>Hosts</span><span class="caret">▾</span></button>
        <div class="nav-dropdown">
          <a href="/admin/hosts.html?host=secure" data-nav-host="secure">Secure hosts</a>
          <a href="/admin/hosts.html?host=insecure" data-nav-host="insecure">Insecure hosts</a>
          <a href="/admin/hosts.html?host=unprovisioned" data-nav-host="unprovisioned">Unprovisioned</a>
          <a href="/admin/hosts.html?newHost=1" data-nav-newhost>+ New host</a>
        </div>
      </div>
      <div class="nav-item has-children" data-nav="logs">
        <button type="button" class="nav-trigger" aria-expanded="false"><span>Logs</span><span class="caret">▾</span></button>
        <div class="nav-dropdown">
          <a href="/admin/logs.html">Client logs</a>
          <a href="/admin/mcp-logs.html">MCP access</a>
        </div>
      </div>
      <div class="nav-item has-children" data-nav="settings">
        <button type="button" class="nav-trigger" aria-expanded="false"><span>Settings</span><span class="caret">▾</span></button>
        <div class="nav-dropdown">
          <a href="/admin/settings.html" data-nav-jump="settings">cdx settings</a>
          <a href="/admin/agents.html" data-nav-jump="agents">Agents</a>
          <a href="/admin/prompts.html" data-nav-jump="prompts">Slash commands</a>
          <a href="/admin/memories.html" data-nav-jump="memories">Memories</a>
          <a href="/admin/config.html">config.toml</a>
        </div>
      </div>
    </nav>
    <div class="nav-actions">
      <button class="nav-btn primary" onclick="window.location.href='/admin/?newHost=1#hosts-panel'">New host</button>
      <button class="nav-btn ghost" onclick="window.location.href='/admin/logs.html'">Client logs</button>
    </div>
  </header>

  <div class="app">
    <div class="content">
      <section class="page-hero">
        <div>
          <p class="eyebrow">Logs</p>
          <h1>MCP Access</h1>
          <p class="muted">Latest MCP requests from hosts. Click a row for details.</p>
        </div>
        <div class="hero-actions">
          <label class="muted" for="limit">Limit</label>
          <input id="limit" type="number" min="1" max="500" value="200" style="width:100px;">
          <button id="refresh" class="ghost tiny-btn" type="button">Refresh</button>
          <span id="status" class="muted"></span>
        </div>
      </section>

      <section class="card panel log-panel">
        <div class="table-wrap log-table-wrap">
          <table id="logTable">
            <thead>
              <tr>
                <th>Time (UTC)</th>
                <th>Host</th>
                <th>Method</th>
                <th>Name</th>
                <th>IP</th>
                <th>Status</th>
                <th>Error</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <div class="modal-backdrop" id="detailModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div>
          <h3 id="modalTitle">MCP Request</h3>
          <div class="muted" id="modalSubtitle"></div>
        </div>
        <button id="modalClose" class="close-btn ghost tiny-btn" aria-label="Close">×</button>
      </div>
      <div id="modalBody" class="detail-grid"></div>
    </div>
  </div>

  <script src="nav.js?v=2025-12-08-05"></script>
  <script>
    (function () {
      const tbody = document.querySelector('#logTable tbody');
      const statusEl = document.getElementById('status');
      const modal = document.getElementById('detailModal');
      const modalBody = document.getElementById('modalBody');
      const modalTitle = document.getElementById('modalTitle');
      const modalSubtitle = document.getElementById('modalSubtitle');

      async function loadLogs() {
        const limit = Math.max(1, Math.min(500, parseInt(document.getElementById('limit').value || '200', 10)));
        statusEl.textContent = 'Loading…';
        try {
          const res = await fetch(`/admin/mcp/logs?limit=${limit}`, { credentials: 'include' });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          const rows = data?.data?.logs || [];
          render(rows);
          statusEl.textContent = `Showing ${Math.min(limit, rows.length)} entries`;
        } catch (err) {
          statusEl.textContent = `Error: ${err.message}`;
        }
      }

      function render(rows) {
        tbody.innerHTML = '';
        if (!rows.length) {
          tbody.innerHTML = '<tr><td class="muted" colspan="7">No entries yet.</td></tr>';
          return;
        }

        rows.forEach((row) => {
          const tr = document.createElement('tr');
          const created = formatUtc(row.created_at);
          const host = formatHost(row);
          const ok = normalizeSuccess(row.success);
          const errorText = formatError(row);

          tr.innerHTML = `
            <td><span class="mono">${escapeHtml(created)}</span></td>
            <td>${escapeHtml(host)}</td>
            <td><code>${escapeHtml(row.method || '')}</code></td>
            <td>${escapeHtml(row.name || '')}</td>
            <td><span class="mono">${escapeHtml(row.client_ip || '')}</span></td>
            <td>${successPill(ok)}</td>
            <td>${escapeHtml(errorText)}</td>
          `;

          tr.addEventListener('click', () => openModal(row, { created, host, ok, errorText }));
          tbody.appendChild(tr);
        });
      }

      function formatHost(row) {
        const host = row.host_fqdn ?? row.fqdn ?? row.host ?? row.host_id ?? '';
        return host ? String(host) : '—';
      }

      function normalizeSuccess(value) {
        if (typeof value === 'boolean') return value;
        if (typeof value === 'string') {
          const lower = value.trim().toLowerCase();
          if (lower === 'false') return false;
          if (lower === 'true') return true;
        }
        const num = Number(value);
        if (Number.isFinite(num)) return num > 0;
        return Boolean(value);
      }

      function successPill(ok) {
        return ok ? '<span class="pill ok">ok</span>' : '<span class="pill err">fail</span>';
      }

      function formatError(row) {
        if (row.error_code === null || row.error_code === undefined || row.error_code === '') return '';
        const msg = row.error_message ? ` ${row.error_message}` : '';
        return `${row.error_code}${msg}`;
      }

      function parseTimestamp(value) {
        if (!value) return null;
        const normalized = String(value).replace(/\.(\d{3})\d*(Z?)/, '.$1$2');
        const date = new Date(normalized);
        return Number.isNaN(date.getTime()) ? null : date;
      }

      function formatUtc(value) {
        const date = parseTimestamp(value);
        if (!date) return value || '—';
        const dd = String(date.getUTCDate()).padStart(2, '0');
        const mm = String(date.getUTCMonth() + 1).padStart(2, '0');
        const yyyy = date.getUTCFullYear();
        const hh = String(date.getUTCHours()).padStart(2, '0');
        const min = String(date.getUTCMinutes()).padStart(2, '0');
        const ss = String(date.getUTCSeconds()).padStart(2, '0');
        return `${dd}.${mm}.${yyyy}, ${hh}:${min}:${ss}`;
      }

      function escapeHtml(str) {
        return String(str ?? '').replace(/[&<>"']/g, (c) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
      }

      function detailRow(label, value, mono = false, allowHtml = false) {
        const classes = `detail-value${mono ? ' mono' : ''}`;
        const display = value === null || value === undefined || value === '' ? '—' : value;
        const content = allowHtml ? display : escapeHtml(display);
        return `<div class="detail-label">${escapeHtml(label)}</div><div class="${classes}">${content}</div>`;
      }

      function openModal(row, derived = {}) {
        const created = derived.created ?? formatUtc(row.created_at);
        const host = derived.host ?? formatHost(row);
        const ok = typeof derived.ok === 'boolean' ? derived.ok : normalizeSuccess(row.success);
        const errorText = derived.errorText ?? formatError(row);

        modalTitle.textContent = row.method ? `MCP ${row.method}` : 'MCP Request';
        modalSubtitle.textContent = created && created !== '—' ? `${created} UTC` : '';
        modalBody.innerHTML = [
          detailRow('Time (UTC)', created, true),
          detailRow('Host', host),
          detailRow('Client IP', row.client_ip || '—', true),
          detailRow('Method', row.method || '—', true),
          detailRow('Name', row.name || '—'),
          detailRow('Status', successPill(ok), false, true),
          detailRow('Error Code', row.error_code ?? '—', true),
          detailRow('Error Message', row.error_message || '—'),
          detailRow('Log ID', row.id ?? '—', true),
        ].join('');

        modal.classList.add('show');
        modal.setAttribute('aria-hidden', 'false');
      }

      function closeModal() {
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden', 'true');
      }

      document.getElementById('refresh').addEventListener('click', loadLogs);
      document.getElementById('limit').addEventListener('keydown', (event) => {
        if (event.key === 'Enter') loadLogs();
      });
      document.getElementById('modalClose').addEventListener('click', closeModal);
      modal.addEventListener('click', (event) => {
        if (event.target === modal) closeModal();
      });
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && modal.classList.contains('show')) {
          closeModal();
        }
      });

      loadLogs();
    })();
  </script>
</body>
</html>

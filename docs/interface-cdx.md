# cdx Wrapper Interface (Source of Truth)

- `cdx` is downloaded per host via `/wrapper/download`; the script is baked with `BASE_URL`, `API_KEY`, `FQDN`, optional CA file (for private/self-signed TLS), optional TLS-bypass flag (`CODEX_SYNC_ALLOW_INSECURE=1` when a host is configured as `curl_insecure`), and the host security flag (`secure`, defaults to on). It can also be baked with per-host `model` and `model_reasoning_effort` defaults (host override wins; otherwise uses the fleet-wide config values). Insecure hosts start with a 30-minute provisioning window so initial sync works immediately; dashboard “Enable” now exposes a log-ish 0–480 minute (0–8 hour) slider (default 10) that re-opens a sliding window for `/auth` calls, and each subsequent `/auth` refresh extends the window by the configured duration. “Disable” closes it immediately (no store grace).
- Source is organized under `bin/cdx.d/*.sh`; run `scripts/build-cdx.sh` to assemble the shipped `bin/cdx`. Edit fragments, not the built file, and bump `WRAPPER_VERSION` whenever `bin/cdx` changes.
- On launch it:
  - Pulls `auth.json` from `/auth` (store/retrieve). If the API is unreachable or returns HTTP 5xx it proceeds with cached auth when `last_refresh` is ≤24h old (or ≤7 days for secure hosts, with a warning) and surfaces the offline reason. It refuses to start when the API key is invalid, the insecure window is closed, the API kill-switch is on, or no recent auth is available. Local `auth.json` validation accepts either `auths` or a `tokens.access_token`/`OPENAI_API_KEY` fallback so `codex login` outputs aren’t discarded before sync.
  - Reports the current user + hostname to `/host/users` (API key + IP binding) and receives the known user list for the host; `--uninstall` removes `~/.codex` for those users (fallback: current user only if the API call fails).
- Honors the server-side ChatGPT quota policy (`quota_hard_fail`, `quota_limit_percent`, and optional `quota_week_partition` daily allowance pacing); admins can flip to warn-only or lower the kill threshold in the dashboard (or set `CODEX_QUOTA_HARD_FAIL=0` / `CODEX_QUOTA_LIMIT_PERCENT=<percent>` before running `cdx`). Hosts marked VIP always receive `quota_hard_fail=false`, regardless of the global policy, so the wrapper warns but never aborts on quota.
  - Surfaces runner telemetry from `/auth` versions (`runner_enabled`, `runner_state`, `runner_last_ok`/`runner_last_fail`/`runner_last_check`) with stale/failure warnings.
  - Shows host usage returned by `/auth` (`api_calls` and current-month token totals including cached/reasoning) in the boot summary.
- TLS: respects baked CA; as a last resort `CODEX_SYNC_ALLOW_INSECURE=1` permits unverified HTTPS for sync/prompt calls (not recommended).
- Synchronizes slash command prompts in `~/.codex/prompts` against `/slash-commands` (lists + per-file retrieve on hash mismatch) and records a baseline; on exit it pushes any changed/new prompts back via `/slash-commands/store`. Server-retired prompts are removed locally.
- Synchronizes Skills in `~/.codex/skills` against `/skills` with the same pull/push workflow (`/skills/retrieve` for diffs, `/skills/store` on exit). Retired Skills remove their local files; manifests remain pure JSON (metadata is captured from JSON fields like `display_name`/`description`).
  - Slash command sync treats API outages/HTTP 5xx as offline (warn) instead of a hard failure; prompt push still runs when possible.
  - AGENTS.md is pulled from `/agents/retrieve` on every run and written to `~/.codex/AGENTS.md` (directory created if missing). The file is **never** pushed upstream; if the server reports `status:missing`, the local AGENTS.md is deleted to avoid stale instructions. Python is required for sync; missing config or offline servers are reported but do not block auth.
	  - `config.toml` is pulled from `/config/retrieve` and written to `~/.codex/config.toml`. The server bakes it per host using the caller’s API key and native HTTP MCP:  
	    ```toml
	    [mcp_servers.cdx]
	    url = "{base_url}/mcp"
	    http_headers = { Authorization = "Bearer {host_api_key}" }
	    ```  
	    When per-host model overrides are set (via the admin Hosts modal), the server also applies them to the baked `config.toml` (`model` and `model_reasoning_effort`) so the host’s file reflects its effective defaults.
	    Responses include `status:updated|unchanged|missing`, baked `sha256`, `base_sha256`, and `content` only when changed. When the server reports `status:missing`, the local file is deleted; offline/missing-config states are surfaced as warnings but do not block auth.
	  - Autodetects/installs `curl`/`unzip`, updates Codex CLI/binary to the server-reported target `versions.client_version`, and self-updates the wrapper (self-update triggers a re-exec; only the final run prints the boot summary to avoid double headers). When the server pins a target version (`client_version_source=locked`, either fleet-wide or per-host), `cdx` enforces the exact target (upgrade or downgrade) so hosts converge on the pinned release.
  - Parses **all** Codex stdout lines like `Token usage: total=… input=… (+ … cached) output=… (reasoning …)` and POSTs them to `/usage` (as an array) with the host API key; if a line cannot be parsed into numbers, it is still sent as raw `line`. The server calculates and stores per-entry/aggregate costs from pricing (env fallbacks `GPT51_*`/`PRICING_CURRENCY`).
  - MCP-compatible memory endpoints live under `/mcp/memories/*` (store/retrieve/search) and reuse the host API key; clients can sync cross-session memories there (content ≤32k, up to 32 tags).
  - The streamable MCP server at `/mcp` (protocol `2025-03-26`) advertises `memory_store|memory_retrieve|memory_search` tool names (underscores only to satisfy `^[a-zA-Z0-9_-]+$`); `tools/call` tolerates dot aliases. It also implements `resources/templates/list` (template `memory_by_id`, URI `memory://{id}`), `resources/list` (recent memories for the host, up to 20), and `resources/read` (returns `text/plain` memory content for the given URI).
- When `/auth` returns a `chatgpt_usage` block, surfaces 5-hour and weekly ChatGPT quota bars during boot (with reset ETA) plus a daily allowance bar when `quota_week_partition` is enabled.
  - Honors fleet-wide silent mode (`cdx_silent` from `/auth` or `CODEX_SILENT=1` env): suppresses info/warn/debug logs and the MOTD; only errors print. Restart-on-update still runs, but the re-exec stays quiet.
  - After Codex runs, pushes updated auth if changed and sends token-usage metrics. When the host is marked **insecure** (API `host.secure=false` or baked flag), `cdx` purges `~/.codex/auth.json` after the push so credentials are not left on disk and emits an extra bootstrap warning to flag the ephemeral state.
- `cdx --uninstall` removes Codex binaries/config, legacy env/auth files, npm `codex-cli`, and calls `DELETE /auth`.
- `cdx --update` forces a wrapper refresh from the server (via `/wrapper/download`) even when versions match, then exits after the update attempt.
- `cdx <profile> [args...]` is shorthand for `cdx --profile <profile> [args...]` when the named profile exists in the synced `config.toml` (`[profiles.<profile>]`); if the profile does not exist, the argument is passed through unchanged.
- `cdx --execute "<prompt>" [args...]` skips all wrapper logging, runs `codex --model gpt-5.1 --sandbox read-only -a untrusted exec --skip-git-repo-check "<prompt>" ...`, captures the final assistant reply via `--output-last-message`, and prints only that reply (no CLI banners/logs); no other wrapper flags may accompany this mode.
- The API can return HTTP 429 when IP rate limits trip (global bucket or repeated invalid API keys). Responses include `bucket`, `limit`, and `reset_at`; callers should back off until `reset_at` before retrying.
- Wrapper publishing: the bundled `bin/cdx` in the Docker image is the source of truth. Rebuilds seed storage automatically; there is no `/wrapper` upload endpoint. Any change to `bin/cdx` must bump `WRAPPER_VERSION`.

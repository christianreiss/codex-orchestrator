# API Interface (Source of Truth)

## Host-facing

- Base URL for baked wrappers/installers honors `PUBLIC_BASE_URL` when set; otherwise it is derived from `X-Forwarded-Host`/`Host` + `X-Forwarded-Proto` (validated against `https?://`). If no valid base can be resolved, installer creation fails and host `/auth` responses omit per-host wrapper baking metadata.
- Pruning: hosts inactive for `inactivity_window_days` (default 30; set to `0` to disable; configurable in Admin Settings → General) are deleted during host auth/register/admin host listings. Never-provisioned hosts older than 30 minutes are also pruned.
- `POST /auth` — retrieve/store canonical `auth.json` for the calling host. Requires API key (`X-API-Key` or `Authorization: Bearer`). `command` defaults to `retrieve`; `retrieve` needs `last_refresh` (RFC3339, ≥ 2000-01-01, ≤ now+300s) and `digest` (64-hex). `store` needs an `auth` payload with RFC3339 `last_refresh` plus `auths` (synthesized from `tokens.access_token` / `OPENAI_API_KEY` when missing). Tokens are canonicalized and quality-checked (no whitespace, min length `TOKEN_MIN_LENGTH` default 24 with an 8-char floor, rejects placeholders/low-entropy). Optional `installation_id` must match the server’s `INSTALLATION_ID` when provided; mismatches return `403 installation_mismatch` while omitted values are treated as legacy clients. Responses include status (`valid`/`upload_required`/`outdated`/`missing` for `retrieve`; `updated`/`unchanged`/`outdated` for `store`), `versions` (client/wrapper plus `client_version_source`, `client_version_checked_at`, `wrapper_sha256`, `wrapper_url`, `reported_client_version`, runner telemetry, `installation_id`), `api_calls`, current-month `token_usage_month`, `quota_hard_fail`, `quota_limit_percent`, `quota_week_partition` (0/off, 5, or 7), **`cdx_silent` (fleet-wide wrapper quiet mode)**, and optional `host` metadata (secure flag, VIP flag, roaming flag, insecure window timestamps, configured `insecure_window_minutes`, optional `client_version_override` (per-host Codex CLI pin; when set, `versions.client_version_source=locked`), plus optional `model_override` / `reasoning_effort_override` used when baking the per-host `cdx` wrapper). Canonical auth is returned whenever the server copy is newer/different. `chatgpt_usage` (when available) carries status/plan/rate flags, `primary_window` and `secondary_window` blocks (`used_percent`, `limit_seconds`, reset timings) plus `next_eligible_at`; the server refreshes the snapshot opportunistically with a 5-minute cooldown. **Insecure hosts default to API deny:** registering an insecure host opens a 30-minute provisioning window; dashboard “Enable” exposes a 2–60 minute slider (default 10) that opens a sliding `/auth` window, and each `/auth` call extends the window by the configured duration. “Disable” closes the window immediately (no store grace). When `host.secure` is `false`, `cdx` purges `~/.codex/auth.json` after each run.
- `DELETE /auth` — deregister host; IP binding enforced unless `?force=1`.
- `POST /host/users` — record the calling host’s current `username`/`hostname` and return all known users for that host. Requires host API key (`X-API-Key` or `Authorization: Bearer`) and IP binding. Response: `{ users: [{ username, hostname, first_seen, last_seen }, ...] }`. Rows are deleted automatically when the host is removed.
- `POST /usage` — token usage telemetry from `cdx`. Body accepts either a single usage entry or `usages` array; each entry may include numeric `total`/`input`/`output` plus optional `cached`, `reasoning`, `model`, or freeform `line` (at least one numeric field or `line` required). Numeric fields must be non-negative numbers (commas allowed, e.g., `10,000`); `line` is sanitized (ANSI/escape stripped, control codes removed, length capped) before storing. Stores an audit ingest row (`token_usage_ingests`, aggregated totals + normalized payload + optional client IP) and one `token_usages` row per entry, logging `token.usage` for each. Per-entry and aggregated `cost` values are calculated from the latest pricing (env fallbacks `GPT51_*`/`PRICING_CURRENCY` when `PRICING_URL` is unset) and stored alongside the tokens; response echoes the per-row costs, ingest `cost`, and `ingest_id`. Internal ingest failures return HTTP 200 with `recorded:false`.
- `GET /wrapper` — wrapper metadata baked for host (version, per-host `sha256` of rendered script, `size_bytes`, `url`). Auth required.
- `GET /wrapper/download` — downloads baked `cdx` wrapper (per-host hash). Auth required; response sets `X-SHA256` + `ETag` and `Content-Length` when available.
- `GET /slash-commands` — list server-known slash command prompts (`filename`, `sha256`, `description`, `argument_hint`, `updated_at`, optional `deleted_at` for retired commands). Auth required.
- `POST /slash-commands/retrieve` — body: `filename` (required) and optional `sha256` (64-hex). Returns `status` (`missing` | `unchanged` | `updated`) plus metadata and `prompt` when the server copy differs from the provided digest.
- `POST /slash-commands/store` — body: `filename`, `prompt` (full file content, e.g., markdown with `---` front matter), optional `description`/`argument_hint`, optional `sha256` (validated against `prompt`). Stores/updates canonical prompt row, logs `slash.store`, and echoes `status` (`created` | `updated` | `unchanged`) with canonical `sha256`.
- `POST /agents/retrieve` — pull the canonical AGENTS.md. Optional body `sha256` (64-hex) lets the server return `status:unchanged` without echoing the file. Response includes `status` (`updated` | `unchanged` | `missing`), `sha256`, `updated_at`, `size_bytes`, and `content` when updated. When `status=missing`, clients should delete their local `~/.codex/AGENTS.md`.
- `POST /config/retrieve` — pulls the canonical config template and bakes a per-host `config.toml` using the authenticated host API key. Managed MCP entry now uses the native HTTP MCP transport (no npm):  
  ```toml
  [mcp_servers.cdx]
  url = "{base_url}/mcp"
  http_headers = { Authorization = "Bearer {host_api_key}" }
  ```  
  When `hosts.model_override` / `hosts.reasoning_effort_override` are set, the baked config also overrides `model` and `model_reasoning_effort` so `~/.codex/config.toml` matches the host’s effective defaults.
  Optional body `sha256` (64-hex) lets the server return `status:unchanged` without echoing the file. Response includes `status` (`updated` | `unchanged` | `missing`), baked `sha256`, `base_sha256` (template sha), `updated_at`, `size_bytes`, and `content` when updated. When `status=missing`, clients should delete their local `~/.codex/config.toml`.
- MCP memories (host API key auth, same rate limits):
  - `POST /mcp/memories/store` — body: `content` (required string, ≤32k chars), optional `id`/`memory_id`/`key` (slug/UUID; generated when omitted), optional `metadata` (object), optional `tags` (up to 32 strings, ≤64 chars each). Status: `created` | `updated` | `unchanged`; echoes `memory` (`id`, `content`, `metadata`, `tags`, `created_at`, `updated_at`).
  - `POST /mcp/memories/retrieve` — body: `id`|`memory_id`|`key` (required). Returns `status:found|missing` plus `memory` when present.
  - `POST /mcp/memories/search` — body: `query`/`q` (string; empty lists recent), optional `limit` (1–100, default 20), optional `tags` (filter requires all provided tags). Matches are ranked by MySQL full‑text score when `query` is set; response includes `matches` with `score` (nullable) and full `memory` payloads.
  - Streamable HTTP MCP endpoint (`/mcp`, protocol `2025-03-26`) advertises tools `memory_store`, `memory_retrieve`, and `memory_search` (underscores only to satisfy the tool-name regex `^[a-zA-Z0-9_-]+$`); `tools/call` still accepts dot aliases for backward compatibility.
  - MCP resources: `resources/templates/list` returns one template (`memory_by_id`, `uriTemplate: memory://{id}`); `resources/list` enumerates recent memories for the calling host (up to 20); `resources/read` fetches a single memory as `text/plain` when given `uri=memory://{id}`.
- `GET /versions` — version snapshot (no auth): `client_version`, `client_version_checked_at`, `client_version_source` (`github`/`cache`/`cache_stale`/`locked`), `wrapper_version`, `wrapper_sha256`, `wrapper_url`, `reported_client_version`, `quota_hard_fail`, `quota_limit_percent`, `quota_week_partition`, `cdx_silent`, and runner telemetry (`runner_enabled`, `runner_state`, `runner_last_ok`, `runner_last_fail`, `runner_last_check`). Wrapper metadata always comes from the baked script; clients cannot publish. When `client_version_source=locked`, the fleet target Codex version is pinned by an admin.

Scheduled preflight: the first non-admin request after an ~8-hour gap (or after a boot) refreshes the cached GitHub client version and runs the auth runner once against canonical auth (runner writes the payload to `~/.codex/auth.json` and runs `codex`). The window is configurable via `AUTH_RUNNER_PREFLIGHT_SECONDS` (defaults to 28800s). Failures flip `runner_state=fail` and set `runner_last_fail`; recovery attempts obey backoff (skip if already checked this interval, 60s short backoff after a failure, retry after ~15m, or when the last OK is stale/boot ID changes). Runner failures are logged/surfaced but do not block `/auth`; admin seed uploads bypass the runner.

## Installer

- `GET /install/{token}` — single-use installer script for a pre-registered host. Tokens minted via `/admin/hosts/register` (one pending token per host; issuing a new one rotates the API key and deletes prior tokens), expire after `INSTALL_TOKEN_TTL_SECONDS` (default 1800s), and embed the resolved public base URL (from token metadata, `PUBLIC_BASE_URL`, or forwarded Host/proto) plus the API key/FQDN into `cdx`. Used/expired/missing tokens return shell-script errors.

## Admin (mTLS on by default)

- `GET /admin/overview` — hosts count, avg refresh age, latest log timestamp, versions (runner/quota flags included), token totals (including reasoning tokens) plus `tokens_month`, ChatGPT usage snapshot (cached ≤5m), pricing snapshot + `pricing_month_cost`, `subscription_plans` (Plus/Pro monthly plan pricing), mTLS metadata (includes `required`/`present` + fingerprint details when provided), and seed signals for new installs (`has_canonical_auth`, `seed_required`, `seed_reasons`), plus the enforced ChatGPT quota threshold (`quota_limit_percent`), week-partition setting (`quota_week_partition`), `cdx_silent` (wrapper quiet mode), and optional Codex version pin metadata (`client_version_lock`, `client_version_lock_updated_at`).
- `GET /admin/hosts` — list hosts with canonical digest, digests history, versions, API calls, IP, roaming flag, security flag (`secure`), VIP flag (`vip`), insecure window fields (`insecure_enabled_until`, `insecure_grace_until`, `insecure_window_minutes`), `force_ipv4` (true = bake IPv4-only installer/wrapper and clear IP binding), per-host overrides (`client_version_override`, `model_override`, `reasoning_effort_override`), latest token usage (including reasoning tokens), `auth_outdated` (true when host digest differs from the current canonical auth), and recorded users (username/hostname/first/last seen).
- `GET /admin/hosts/insecure` — list insecure hosts only (no secure hosts). Returns `count`, `active` (how many have `insecure_enabled_until` in the future), and `hosts` with `id`, `fqdn`, `active` and `insecure_enabled_until` (RFC3339 / `DATE_ATOM`, timezone-aware). Intended for quick UI actions (e.g. enable/disable buttons).
- `POST /admin/hosts/register` — mint a host + single-use installer token for a given FQDN; calling it again for the same FQDN rotates that host’s API key, deletes prior pending installers, and issues a fresh one. Optional body `secure` (default `true`) marks the host as secure vs. insecure (ephemeral auth); optional `vip` (default `false`) flags the host as VIP immediately (always warn on quota). New insecure hosts auto-open a 30-minute provisioning window so setup can proceed without extra clicks. Installer tokens capture the public base URL (Host/proto or `PUBLIC_BASE_URL`) to bake into `cdx`; creation fails if no valid base is available.
- `GET /admin/hosts/{id}/auth` — canonical digest/last refresh, recent digests, optional `auth` body (`?include_body=1`).
- `POST /admin/hosts/{id}/secure` — toggle the host’s security mode (`secure: true` keeps auth.json locally; `false` makes `cdx` purge it after each run).
- `POST /admin/hosts/{id}/vip` — toggle VIP status (`vip: true` means quota kill switch is never enforced for this host; warn-only even when the global policy is deny).
- `POST /admin/hosts/{id}/insecure/enable` — for insecure hosts only; opens a sliding window where `/auth` calls are permitted. Optional JSON body `duration_minutes` sets the window length (integer 2–60, defaults to the last stored value or 10). Each `/auth` call extends the window by the configured duration.
- `POST /admin/hosts/{id}/insecure/disable` — closes the window immediately (no grace; both retrieve/store are denied until re-enabled).
- `POST /admin/hosts/{id}/roaming` — toggle `allow_roaming_ips`.
- `POST /admin/hosts/{id}/ipv4` — toggle IPv4-only mode (`force` boolean). Clears the stored IP and bakes future installers/wrappers with `curl -4`.
- `POST /admin/hosts/{id}/model` — set per-host model overrides. Body: `{model_override: string|null, reasoning_effort_override: string|null}`. Null/empty values mean “Standard (global)”; changes apply to the baked per-host `cdx` wrapper.
- `POST /admin/hosts/{id}/codex-version` — set per-host Codex CLI version override. Body: `{selection: "global"|"<x.y.z>"}` (or `client_version_override` as a string/null). `global` clears the override and uses the fleet policy; selecting a version pins this host and forces `client_version_source=locked` in `/auth` responses so the wrapper enforces the exact target.
- `POST /admin/hosts/{id}/clear` — clears canonical auth state for the host (resets `last_refresh`/`auth_digest`, deletes `host_auth_states`, and prunes recent digests).
- `DELETE /admin/hosts/{id}` — delete host + digests.
- `POST /admin/auth/upload` — validate/store canonical `auth.json` (system or host-scoped). Runner is skipped for this seed/upload flow.
- `GET /admin/api/state` / `POST /admin/api/state` — read/set persisted `api_disabled` flag (when true, all API routes return 503; `/admin/api/state` stays reachable so operators can re-enable).
- `GET /admin/quota-mode` / `POST /admin/quota-mode` — read/set ChatGPT quota policy (`hard_fail` boolean), the warn/kill threshold (`limit_percent`, integer 50–100), and optional weekly partitioning (`week_partition`: `0|off`, `7`, or `5`). When `false`, `cdx` warns once usage meets the configured limit but still launches Codex; when `true`, exceeding the limit blocks execution. A non-zero `week_partition` adds a daily allowance bar in `cdx` (derived from the weekly window) that obeys the same warn/deny policy.
- `GET /admin/cdx-silent` / `POST /admin/cdx-silent` — read/set fleet-wide wrapper quiet mode (`silent` boolean). When enabled, `cdx` suppresses boot info/warn logs and only emits errors.
- `POST /admin/codex-version` — set the fleet Codex CLI version policy. Body: `{selection: "latest"|"<x.y.z>"}`. `latest` keeps the GitHub-latest flow; selecting a specific version pins `versions.client_version` and switches `client_version_source` to `locked`.
- `GET /admin/logs?limit=` — recent audit events.
- `GET /admin/usage?limit=` — recent token usage rows (with host + reasoning tokens when present).
- `GET /admin/usage/ingests?page=&per_page=&q=&sort=&direction=&host_id=` — paginated `/usage` ingest audits (aggregated totals + entry count + optional client IP/payload + `cost`) with host lookups; default sort is `created_at desc`. Supports fuzzy search on host FQDN/client IP or numeric ID/host_id, sortable keys: `created_at`, `entries`, `total`, `input`, `output`, `cached`, `reasoning`, `cost`, `host`, `client_ip`, `id`. `per_page` max 200. Response includes the pricing `currency` currently in use.
- `GET /admin/usage/cost-history?days=60` — daily cost history (input/output/cached + total) derived from token usage and the latest pricing snapshot; capped to 180 days and anchored to the earliest token record when that is newer than the lookback. Returns `points` (one per UTC day), `currency`, `pricing`, `has_pricing`, `since`, `until`, `days`.
- `GET /admin/tokens?limit=` — token usage aggregates per token line (sums total/input/output/cached/reasoning).
- `GET /admin/runner` — runner config/telemetry (enabled flag, runner/base URL, timeout, `boot_id`, `runner_state`, `runner_last_ok`/`runner_last_fail`/`runner_last_check`, validation + runner_store counts from the last 24h, and the latest validation/runner_store log entries with host/digest/last_refresh). `POST /admin/runner/run` — manual runner execution (forces a run and returns whether canonical auth changed plus runner timestamps).
- `POST /admin/versions/check` — refresh GitHub client release cache.
- `GET /admin/chatgpt/usage[?force=1]` — account-level ChatGPT `/wham/usage` snapshot using canonical `auth.json` token (5-minute cooldown unless `force`).
- `GET /admin/chatgpt/usage/history?days=60` — quota history for dashboard graphs (5-hour + weekly `used_percent` with `fetched_at`), capped to the past 180 days; default window is 60 days or since the first data point.
- `POST /admin/chatgpt/usage/refresh` — force-refresh ChatGPT usage snapshot (bypasses cooldown).
- `GET /admin/agents` — fetch canonical AGENTS.md (sha, updated timestamp, size, and full `content`) for editing in the dashboard.
- `POST /admin/agents/store` — replace canonical AGENTS.md. Body: `content` (string markdown), optional `sha256` check (64-hex). Returns `status` (`created` | `updated` | `unchanged`), `sha256`, `updated_at`, `size_bytes`.
- `GET /admin/config` — fetch canonical `config.toml` metadata + `content` + `settings` (the structured builder payload). Returns `status` (`missing` when unset), `sha256`, `updated_at`, `size_bytes`.
- `POST /admin/config/render` — render a `settings` payload into TOML without persisting it. Returns `content`, `sha256`, `size_bytes`, and the normalized `settings`.
- `POST /admin/config/store` — persist canonical `config.toml` built from the provided `settings` payload. Optional `sha256` acts like an optimistic concurrency check: when a config already exists, the provided sha must match the currently saved config sha (reload before saving when it doesn’t). Returns `status` (`created` | `updated` | `unchanged`), `sha256`, `updated_at`, `size_bytes`, `content`, and normalized `settings`.
- `GET /admin/mcp/memories` — browse MCP memories. Query: `q`/`query` (optional text), `host_id` (optional), `tags` (comma/space separated), `limit` (1–200, default 50). Returns `matches` with host, id, content, metadata, tags, timestamps, and optional search `score`.
- `GET /admin/slash-commands` — list server-stored slash command prompts (filename, sha256, description, argument hint, timestamps).
- `GET /admin/slash-commands/{filename}` — fetch a single slash command (includes full prompt body).
- `POST /admin/slash-commands/store` — create/update a slash command (body: `filename`, `prompt`, optional `description`/`argument_hint`/`sha256`; sha is computed if omitted).
- `DELETE /admin/slash-commands/{filename}` — retire a slash command (marks deleted; hosts remove it on next sync).
- Pricing: auto-fetches GPT-5.1 pricing (daily) from `PRICING_URL` or env fallback and surfaces `tokens_day` (UTC day), `tokens_week` (aligned to the ChatGPT weekly window when available, else trailing 7 days), `tokens_month` (month to date), `pricing`, `pricing_day_cost`, `pricing_week_cost`, and `pricing_month_cost` in `/admin/overview` for dashboard cost calculations. `subscription_plans` is sourced from `CHATGPT_PLUS_PLAN_COST` / `CHATGPT_PRO_PLAN_COST` (currency follows `PRICING_CURRENCY`). Daily cost history for dashboard charts is available via `/admin/usage/cost-history`.

## Auth + IP rules

- API key is bound to first caller IP; subsequent calls from a new IP are blocked unless `allow_roaming_ips` is enabled via admin or `?force=1` on `DELETE /auth`.
- Admin endpoints require mTLS (`X-mTLS-Present` header) when `ADMIN_ACCESS_MODE=mtls` (default). With `ADMIN_ACCESS_MODE=none`, mTLS headers become optional—lock down `/admin` via another control (VPN, firewall).
- Runner IP bypass: when `AUTH_RUNNER_IP_BYPASS=1` and `AUTH_RUNNER_BYPASS_SUBNETS` contains CIDRs, runner-originated `/auth` validation can proceed without rebinding the stored host IP (logged as `auth.runner_ip_bypass`).

## Rate limiting

- Global throttle for non-admin paths: per-IP `global` bucket defaults to `RATE_LIMIT_GLOBAL_PER_MINUTE=120` over `RATE_LIMIT_GLOBAL_WINDOW=60` seconds. Exceeding the limit returns HTTP 429 with `{ bucket: "global", reset_at, limit }`.
- Brute-force guard: repeated missing/invalid API keys are counted per IP in the `auth-fail` bucket. Defaults: `RATE_LIMIT_AUTH_FAIL_COUNT=20` failures within `RATE_LIMIT_AUTH_FAIL_WINDOW=600` seconds, extending the block for `RATE_LIMIT_AUTH_FAIL_BLOCK=1800` seconds once tripped. Limit hits return HTTP 429 `Too many failed authentication attempts` with `reset_at` + `bucket`.
- Admin routes are exempt; when no client IP can be resolved the request proceeds without throttling. Tune the env vars above to tighten or disable the windows (zero/negative disables the guard).
## Admin access control

Admin routes are protected by mTLS (client certificates). Passkey/WebAuthn endpoints are not implemented.
